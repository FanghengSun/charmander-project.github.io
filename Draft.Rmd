---
title: "Draft"
output: github_document
---


```{r setup, include = FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(patchwork)
library(plotly)
library(png)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Introduction

### Forest Fire

---

### Montesinho

The Montesinho Natural Park is one of the largest natural parks in Portugal.

The schist and granite mountains form deep valleys and the clear river water flowing through them. 

The geological diversity of this space and variations in soil characteristics and climate, originate a highly varied plant life, and an ideal habitat for animals such as the wolf, wild boar, roe deer and around 240 other animal species.

Montesinho is home to many different kinds of animals. Its biodiversity includes the Iberian wolf, roe deer, wild boar, Iberian lynx, common genet, red fox and European otter.
(Add some images of the animals)


---

### Dataset
The forest fire data concerns burned areas of the forests in Montesinho Natural park due to forest fires.

---

### Variables

* X - x-axis spatial coordinate within the Montesinho park map: 1 to 9
* Y - y-axis spatial coordinate within the Montesinho park map: 2 to 9
* month - month of the year: 'jan' to 'dec'
* day - day of the week: 'mon' to 'sun'
* FFMC - FFMC index from the FWI system: 18.7 to 96.20
* DMC - DMC index from the FWI system: 1.1 to 291.3
* DC - DC index from the FWI system: 7.9 to 860.6
* ISI - ISI index from the FWI system: 0.0 to 56.10
* temp - temperature in Celsius degrees: 2.2 to 33.30
* RH - relative humidity in %: 15.0 to 100
* wind - wind speed in km/h: 0.40 to 9.40
* rain - outside rain in mm/m2 : 0.0 to 6.4
* area - the burned area of the forest (in ha): 0.00 to 1090.84
(this output variable is very skewed towards 0.0, thus it may make
sense to model with the logarithm transform)

For more information, read [Cortez and Morais, 2007].

---

### Questions
* Distribution: How is the forest fire distributed in the park? How large can the forest fire be? (put in summary table)
* Prediction: What are the significant variables to predict forest fire?
* Associations: How are these variables related to the area of forest fire?
* Suggestions: What can we suggest from the data? (Ex: For tourists and fire department)
* Future Plans: How is the variables related to each other? Can we give a more precise prediction of the area based on the variables we have now?

---

### Plots (plotly)

load in data
```{r}
fire_df = read_csv("./data/forestfires.csv")
fire_df
```

Add/Merge the file to website.

## boxplot (month)
Answering the question that whether there is a difference in weather and climate of days that there is a fire and no fire.

```{r month+group_by area, facet_grid}
fire_box = 
  fire_df %>% 
  select(FFMC, DMC, DC, ISI, temp, RH, wind, rain, area) %>% 
  mutate(fire = ifelse(area > 0, "fire", "no fire"))

# temperature boxplots
fire_box %>% 
  group_by(fire) %>% 
  plot_ly(
    y = ~temp, x = ~fire, color = ~fire,
    type = "box", colors = "viridis"
  )


```

Overlay the plot to map. Add make a rmd file. 

---

## Scatterplot (geography)

```{r x+y}
geo_1 = 
  fire_df %>% 
  select(X, Y, area) %>% 
  group_by(X, Y) %>% 
  mutate(total = sum(area)) %>% 
  select(-area) %>% 
  distinct() %>% 
  ungroup() 

geo_2 = 
  expand.grid(
    X = unique(pull(geo_1, X)),
    Y = unique(pull(geo_1, X))
  )

geo_3 = 
  merge(
    geo_2, geo_1, all = TRUE
  ) %>% 
  arrange(Y, X)

geo_4 = 
  geo_3 %>% 
  mutate(
    Y = -Y
  ) 

geo_4[is.na(geo_4)] <- 0

map_image = png::readPNG("map.png")

map_image_g = grid::rasterGrob(map_image, width = unit(0.89,"npc"), height = unit(0.89,"npc"))

overlap = 
  ggplot(geo_4, aes(X, Y, fill = total)) + 
  annotation_custom(map_image_g) +
  geom_tile() +
  theme_void() +
  theme(aspect.ratio = nrow(map_image)/ncol(map_image)) +
  scale_fill_gradient(low = "transparent", high = "red")
```

## scatterplot (rain, RH)

```{r rain+RH}
fire_df %>% 
  mutate(days = ifelse(day %in% c('sat', 'sun'),'weekend', 'weekday')) %>% 
  plot_ly(
    y = ~rain, x = ~RH,
    type = 'scatter', colors = 'viridis', color = ~days, mode = 'markers', hoverinfo = 'text',
        text = ~paste('</br> Month: ', month,
                      '</br> Relative Humidity (%): ', RH,
                      '</br> Rain (mm/m2): ', rain))

how_many_days <- as.data.frame(table(fire_df$day))
how_many_days = 
  how_many_days%>% 
  mutate(group = ifelse(Var1 %in% c('sat', 'sun'),'weekend', 'weekday'))
weekday_vs_weekend = 
  how_many_days %>% 
  group_by(group) %>% 
  summarise_at(vars(Freq), list(name = sum))
```
Calculation: num of weekday / num of weekend  = 338 / 179 = 1.89
###Test: Chi-sqr test for homo + Wilcoxon rank-sum test.
---

## Bar chart (month)

Comments:
1. Add text label on bar chart.
2. change month order.

### barchart (ggplot+ggplotly)
```{r barchart_ggplot+ggplotly}
fire_mon = 
  fire_df %>% 
  filter(area>0) %>%
  mutate(month = stringi::stri_trans_totitle(month)) %>%
  mutate(month = factor(month, 
                        levels = c('Jan', 'Feb', 'Mar', 'Apr',
                                   'May', 'Jun', 'Jul', 'Aug',
                                   'Sep', 'Oct', 'Nov', 'Dec'),
                        ordered = TRUE))

bar_plot =
  fire_mon %>%
  ggplot(aes(x = month, fill = month)) + 
  geom_bar() + scale_fill_viridis_d(direction = -1) +
  xlab('Month') + ylab('Count (s)')

ggplotly(bar_plot)
```
Problems: text for each month

### barchart (plotly)
```{r barchart_plotly}
fire_mon = 
  fire_df %>% 
  filter(area > 0) %>%
  mutate(month = stringi::stri_trans_totitle(month))

fire_mon %>%
  count(month) %>% 
  mutate(month = fct_reorder(month, n)) %>% 
  mutate(month = factor(month, 
                        levels = c('Jan', 'Feb', 'Mar', 'Apr',
                                   'May', 'Jun', 'Jul', 'Aug',
                                   'Sep', 'Oct', 'Nov', 'Dec'),
                        ordered = TRUE)) %>%
  plot_ly(x = ~month, y = ~n, color = ~month, type = "bar", colors = "viridis")
```
Problems:
1. Nov
2. the order fo x-label
3. cannot change direction of colors

---

### Test (ANOVA)

```{r anova}
fire_df_2 = 
  fire_df %>% 
  select(FFMC, DMC, DC, ISI, temp, RH, wind, rain, area) %>% 
  mutate(fire = ifelse(area > 0, "fire", "no fire"))

# FFMC
fire_ffmc = 
  fire_df_2 %>%
  select(FFMC, fire)
anova_ffmc = lm(FFMC ~ factor(fire), data = fire_ffmc)
anova(anova_ffmc)

# DMC
fire_dmc = 
  fire_df_2 %>%
  select(DMC, fire)
anova_dmc = lm(DMC ~ factor(fire), data = fire_dmc)
anova(anova_dmc)

# DC
fire_dc = 
  fire_df_2 %>%
  select(DC, fire)
anova_dc = lm(DC ~ factor(fire), data = fire_dc)
anova(anova_dc)


# ISI
fire_isi = 
  fire_df_2 %>%
  select(ISI, fire)
anova_isi = lm(ISI ~ factor(fire), data = fire_isi)
anova(anova_isi)

# Temp
fire_temp = 
  fire_df_2 %>%
  select(temp, fire)
anova_temp = lm(temp ~ factor(fire), data = fire_temp)
anova(anova_temp)

# RH
fire_rh = 
  fire_df_2 %>%
  select(RH, fire)
anova_rh = lm(RH ~ factor(fire), data = fire_rh)
anova(anova_rh)

# Wind
fire_wind = 
  fire_df_2 %>%
  select(wind, fire)
anova_wind = lm(wind ~ factor(fire), data = fire_wind)
anova(anova_wind)

# Rain
fire_rain = 
  fire_df_2 %>%
  select(rain, fire)
anova_rain = lm(rain ~ factor(fire), data = fire_rain)
anova(anova_rain)
```

## Website

1. Index: picture, title, member 
2. About: motivation, methods, dataset, screencast
3. Overview: geography, barchart (number of fire, rain, relative humidity)
4. Data Analysis: shiny
5. Test: ANOVA, Regression
6. Conclusion